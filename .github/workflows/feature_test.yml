name: Feature Branch Test

concurrency:
  group: publish
  cancel-in-progress: true

on:
    workflow_dispatch:    
    push:
      branches:
        - feature/*

env:
  NPM_TOKEN: ${{ secrets.GH_ORG_ACCESS_TOKEN }}
  AWS_ACCESS_KEY_ID: ${{ secrets.OTP_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.OTP_SECRET_ACCESS_KEY }}
  AWS_REGION: ap-southeast-2

jobs:
  test-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: test
        working-directory: ./
        run: |
          sudo apt update -y
          sudo apt install software-properties-common apt-transport-https wget -y
          wget -q https://packages.microsoft.com/keys/microsoft.asc -O- | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
          sudo apt install code
          code --version

          git config --global core.editor "code --wait"
          git config --global user.name otp-ci
          git config --global user.email otpci@oohmedia.com.au
          git remote set-url origin https://otp-ci:${{ secrets.GH_ADMIN_TOKEN }}@github.com/oohmedia/serverless-secrets.git
          npm config set sign-git-tag true
          export VERSION_TAG=`node -p "require('./package.json').version"`
          echo $VERSION_TAG
          # git tag -a $VERSION_TAG -m "release_added"
          # git push origin $VERSION_TAG
          #### NOT PUBLISH in feature branch #### n#m publish --access=restricted
          npm install -g yarn
          yarn install
          echo "### Running audits ###"
          yarn audit --level critical
          echo "### Running test ###"
          yarn test
          echo "Feature branch test completed successfully."
